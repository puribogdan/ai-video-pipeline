<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Video Pipeline</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
      }
      .card {
        border: 1px solid #ccc;
        padding: 1em;
        margin-bottom: 1.5em;
        border-radius: 6px;
      }
      .row {
        display: flex;
        flex-direction: column;
        gap: 1em;
      }
      label {
        font-weight: bold;
      }
      input[type='file'],
      input[type='email'],
      select {
        width: 100%;
        padding: 0.4em;
      }
      button {
        background: #007bff;
        color: white;
        padding: 0.5em 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .muted {
        color: #666;
        font-size: 0.9em;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .file-selected {
        color: #28a745;
        font-size: 0.9em;
        margin-top: 0.25em;
      }
      .file-not-selected {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: 0.25em;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <form action="/submit" method="post" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label for="email">Email</label><br />
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="you@example.com"
            />
          </div>

          <div>
            <label for="audio">Audio (MP3/WAV/M4A, up to 50 MB)</label><br />
            <input
              type="file"
              id="audio"
              name="audio"
              accept="audio/mpeg,audio/wav,audio/m4a,audio/x-m4a,audio/mp4"
              required
            />
            <div id="audio-status" class="file-not-selected"
              >No audio file selected</div
            >
          </div>

          <div>
            <label for="portrait"
              >Portrait (optional, JPG/PNG, up to 8 MB)</label
            ><br />
            <input
              type="file"
              id="portrait"
              name="portrait"
              accept="image/jpeg,image/png"
            />
          </div>

          <div>
            <label for="style">Visual Style</label><br />
            <select id="style" name="style" required>
              <option value="kid" selected>Kid-Friendly Cartoon</option>
              <option value="anime">Style-Anime-Inspired</option>
              <option value="3d">Style-Realistic 3D (Pixar/DreamWorks)</option>
              <option value="storybook"
                >Style-Storybook / Illustrated Paper-Cutout</option
              >
              <option value="fantasy">Style-Fantasy / Magical Glow</option>
              <option value="japanese_kawaii">Japanese Kawaii Style</option>
              <option value="claymation"
                >Claymation Style (Tumble Leaf Inspired)</option
              >
              <option value="watercolor">Watercolor Style</option>
              <option value="pixel_art">Pixel Art (Minecraft Inspired)</option>
              <option value="paper_cutout"
                >Paper Cut-Out (South Park Style)</option
              >
              <option value="van_gogh">Van Gogh Paint Style</option>
              <option value="felt_needle"
                >Felt/Needle-Felted Animation (Pui Pui Molcar Inspired)</option
              >
              <option value="stop_motion_felt_clay"
                >Stop-Motion Felt & Clay (Pokémon Concierge Inspired)</option
              >
              <option value="hybrid_mix"
                >Hybrid Mix (2D + 3D, Gumball Inspired)</option
              >
              <option value="silhouette">Silhouette / Shadow Play</option>
              <option value="cutout_collage">Cut-Out Collage</option>
              <option value="graphic_novel">Graphic Novel Style</option>
              <option value="motion_comic"
                >Motion Comic / Limited Animation (Manga Inspired)</option
              >
              <option value="comic_book"
                >Comic Book Style (Superhero Inspired)</option
              >
              <option value="art_deco"
                >Art Deco (Tamara de Lempicka / 1920s Posters)</option
              >
              <option value="impressionism"
                >Impressionism (Monet / Renoir Inspired)</option
              >
              <option value="cubism">Picasso Cubism</option>
              <option value="tim_burton">Tim Burton Style</option>
              <option value="dr_seuss">Dr. Seuss + Surrealism Hybrid</option>
              <option value="ink_parchment"
                >Ink & Parchment Chinese Scroll</option
              >
              <option value="ukiyo_e"
                >Japanese Screen-Print Storybook Style (Ukiyo-e)</option
              >
              <option value="sumi_e">Ink Wash Style (Sumi-e)</option>
              <option value="byobu">Japanese Gold Screen Style (Byōbu)</option>
              <option value="emakimono"
                >Japanese Scroll Storytelling (Emakimono)</option
              >
              <option value="yamato_e"
                >Japanese Court Painting Style (Yamato-e)</option
              >
            </select>
            <p class="muted" style="margin: 0.25em 0 0">
              This affects only the “style” line in the prompts.
            </p>
          </div>

          <div>
            <button type="submit" id="submit-btn" disabled>Submit</button>
          </div>
        </div>
      </form>
    </div>

    <script>
      // Audio validation functionality - runs on all pages
      (function () {
        const audioInput = document.getElementById('audio');
        const submitBtn = document.getElementById('submit-btn');
        const audioStatus = document.getElementById('audio-status');

        function validateAudio() {
          const file = audioInput.files[0];
          if (file) {
            // Check if file is an audio file
            const validTypes = [
              'audio/mpeg',
              'audio/wav',
              'audio/m4a',
              'audio/x-m4a',
              'audio/mp4',
            ];
            if (
              validTypes.includes(file.type) ||
              file.name.toLowerCase().match(/\.(mp3|wav|m4a|mp4)$/)
            ) {
              audioStatus.textContent = `✓ Audio selected: ${file.name}`;
              audioStatus.className = 'file-selected';
              submitBtn.disabled = false;
              return true;
            } else {
              audioStatus.textContent =
                '✗ Please select a valid audio file (MP3, WAV, M4A, MP4)';
              audioStatus.className = 'file-not-selected';
              submitBtn.disabled = true;
              return false;
            }
          } else {
            audioStatus.textContent = 'No audio file selected';
            audioStatus.className = 'file-not-selected';
            submitBtn.disabled = true;
            return false;
          }
        }

        // Add event listener for audio file selection
        audioInput.addEventListener('change', validateAudio);

        // Prevent form submission if no valid audio
        document.querySelector('form').addEventListener('submit', function (e) {
          if (!validateAudio()) {
            e.preventDefault();
            return false;
          }
        });

        // Initialize button state
        submitBtn.disabled = true;
      })();
    </script>

    {% if job_id %}
    <div class="card" id="job">
      <p>Job queued: <code>{{ job_id }}</code></p>
      <p class="muted">
        This page will update automatically. You can also track status at
        <a href="/status/{{ job_id }}" target="_blank" rel="noopener"
          >/status/{{ job_id }}</a
        >.
      </p>
      <p id="status">Starting…</p>
      <p id="result"></p>
    </div>

    <script>
      (function () {
        const jobId = "{{ job_id | default('') }}";
        if (!jobId) return;
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');
        const update = (msg) => {
          statusEl.textContent = msg;
        };
        update('Queue…');

        const intervalMs = 45000;
        const poll = setInterval(async () => {
          try {
            const r = await fetch(`/status/${jobId}`, { cache: 'no-store' });
            const data = await r.json();
            if (data.state === 'done' && data.result && data.result.video_url) {
              clearInterval(poll);
              update('Done!');
              resultEl.innerHTML = `<a href="${data.result.video_url}" target="_blank" rel="noopener">Download your video</a>`;
            } else if (data.state === 'failed') {
              clearInterval(poll);
              update('Failed. Please try again.');
              if (data.exc) {
                const pre = document.createElement('pre');
                pre.textContent = data.exc;
                pre.style.whiteSpace = 'pre-wrap';
                resultEl.appendChild(pre);
              }
            } else if (
              data.state === 'processing' &&
              data.result &&
              data.result.message
            ) {
              update(data.result.message + '…');
            } else if (
              data.state === 'active' &&
              data.result &&
              data.result.message
            ) {
              update(data.result.message + '…');
            } else {
              // Handle different states with appropriate messages
              const statusMessages = {
                queue: 'Queue - waiting for processing…',
                active: 'Active - starting processing…',
                processing: 'Processing - generating your video…',
                failed: 'Failed - please try again…',
                done: 'Done - video ready!',
              };
              update(statusMessages[data.state] || `Status: ${data.state}…`);
            }
          } catch (e) {}
        }, intervalMs);
      })();
    </script>
    {% endif %}
  </body>
</html>
